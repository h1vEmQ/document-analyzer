<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h5>üîë –¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</h5>
                    </div>
                    <div class="card-body">
                        <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ ID: <strong>111</strong></p>
                        
                        <button type="button" class="btn btn-primary" onclick="generateKeyPoints(111)">
                            <i class="fas fa-magic"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
                        </button>
                        
                        <div id="key-points-loading" class="text-center mt-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã...</p>
                            <small class="text-muted">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 90 —Å–µ–∫—É–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –º–æ–¥–µ–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.</small>
                            <div class="mt-3">
                                <div class="progress" style="height: 6px;">
                                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" style="width: 0%"></div>
                                </div>
                                <small id="progress-text" class="text-muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</small>
                            </div>
                        </div>
                        
                        <div id="key-points-result" class="mt-4" style="display: none;">
                            <div class="alert alert-success">
                                <h6><i class="fas fa-check-circle"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç:</h6>
                                <div id="result-content"></div>
                            </div>
                        </div>
                        
                        <div id="key-points-error" class="mt-4" style="display: none;">
                            <div class="alert alert-danger">
                                <h6><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞:</h6>
                                <div id="error-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function generateKeyPoints(documentId) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('key-points-loading').style.display = 'block';
            document.getElementById('key-points-result').style.display = 'none';
            document.getElementById('key-points-error').style.display = 'none';
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            let progress = 0;
            
            // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const progressInterval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 90) progress = 90; // –ù–µ –¥–æ—Ö–æ–¥–∏–º –¥–æ 100% –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                progressBar.style.width = progress + '%';
                
                if (progress < 20) {
                    progressText.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
                } else if (progress < 40) {
                    progressText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...';
                } else if (progress < 60) {
                    progressText.textContent = '–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...';
                } else if (progress < 80) {
                    progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤...';
                } else {
                    progressText.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...';
                }
            }, 1000);
            
            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            const stopProgress = () => {
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                progressText.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ!';
            };
            
            // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
            fetch(`http://localhost:8000/documents/${documentId}/generate-key-points-test/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                signal: AbortSignal.timeout(90000) // 90 —Å–µ–∫—É–Ω–¥
            })
            .then(response => {
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return response.text(); // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
            })
            .then(text => {
                console.log('Raw response:', text);
                
                try {
                    const data = JSON.parse(text);
                    console.log('Parsed data:', data);
                    
                    if (data.success) {
                        console.log('Generation successful!');
                        stopProgress();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                        document.getElementById('key-points-loading').style.display = 'none';
                        document.getElementById('key-points-result').style.display = 'block';
                        document.getElementById('result-content').innerHTML = `
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${data.message}</p>
                            <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤:</strong> ${data.key_points_count}</p>
                            <p><strong>–î–æ–∫—É–º–µ–Ω—Ç:</strong> ${data.document_title}</p>
                            <p><strong>ID –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> ${data.document_id}</p>
                        `;
                    } else {
                        console.error('Generation failed:', data.error);
                        stopProgress();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                        document.getElementById('key-points-loading').style.display = 'none';
                        document.getElementById('key-points-error').style.display = 'block';
                        document.getElementById('error-content').textContent = data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    }
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Response text:', text);
                    stopProgress();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞
                    document.getElementById('key-points-loading').style.display = 'none';
                    document.getElementById('key-points-error').style.display = 'block';
                    document.getElementById('error-content').innerHTML = `
                        <p>–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞.</p>
                        <p><strong>–î–µ—Ç–∞–ª–∏:</strong> ${parseError.message}</p>
                        <p><strong>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</strong></p>
                        <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px;">${text}</pre>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                stopProgress();
                
                if (error.name === 'TimeoutError') {
                    document.getElementById('key-points-loading').style.display = 'none';
                    document.getElementById('key-points-error').style.display = 'block';
                    document.getElementById('error-content').textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (90 —Å–µ–∫—É–Ω–¥).';
                } else {
                    document.getElementById('key-points-loading').style.display = 'none';
                    document.getElementById('key-points-error').style.display = 'block';
                    document.getElementById('error-content').textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: ' + error.message;
                }
            });
        }
    </script>
</body>
</html>
