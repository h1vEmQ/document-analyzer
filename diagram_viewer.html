<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Просмотр диаграмм упрощенной архитектуры</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .diagram-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        .diagram-title {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
        }
        .mermaid {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #2980b9;
        }
        .active {
            background: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Архитектура упрощенной системы анализа отчетов Word</h1>
        
        <div class="controls">
            <button onclick="showAll()">Показать все</button>
            <button onclick="hideAll()">Скрыть все</button>
            <button onclick="toggleDiagram('architecture')">Архитектура</button>
            <button onclick="toggleDiagram('deployment')">Развертывание</button>
            <button onclick="toggleDiagram('dataflow')">Потоки данных</button>
        </div>

        <div id="architecture" class="diagram-section">
            <div class="diagram-title">1. Общая архитектура упрощенной системы</div>
            <div class="description">
                Упрощенная многоуровневая архитектура на базе Django с разделением на клиентский, веб-серверный, 
                прикладной уровни, уровень данных и системные сервисы. Включает базовые компоненты безопасности РЕДОС 7.3.
            </div>
            <div class="mermaid">
graph TB
    %% Клиентский уровень
    subgraph "Клиентский уровень"
        WEB[Веб-интерфейс<br/>Django Templates + Bootstrap]
        EMAIL[Email клиент<br/>Получение отчетов]
    end

    %% Веб-серверный уровень
    subgraph "Веб-серверный уровень"
        APACHE[Apache HTTP Server 2.4+<br/>mod_wsgi<br/>SSL/TLS]
    end

    %% Прикладной уровень
    subgraph "Django Приложение"
        subgraph "Django Framework"
            DJANGO[Django<br/>Веб-фреймворк<br/>Аутентификация<br/>Шаблоны]
        end
        
        subgraph "Django Apps"
            UPLOAD[Модуль загрузки<br/>документов]
            PARSER[Модуль парсинга<br/>Word документов]
            ANALYZER[Модуль анализа<br/>изменений]
            REPORT[Модуль генерации<br/>отчетов]
            EMAIL_SVC[Email сервис<br/>уведомления]
        end
    end

    %% Уровень данных
    subgraph "Уровень данных"
        SQLITE[(SQLite<br/>База данных Django)]
        FILES[Файловое хранилище<br/>Django File Storage]
    end

    %% Системные сервисы
    subgraph "Системные сервисы"
        DJANGO_EMAIL[Django Email Backend<br/>Отправка email]
        RSYSLOG[rsyslog<br/>Логирование]
        AUDIT[auditd<br/>Базовый аудит]
        FIREWALL[firewalld<br/>Сетевой экран]
    end

    %% Безопасность
    subgraph "Безопасность РЕДОС"
        SELINUX[SELinux<br/>Принудительный режим]
    end

    %% Соединения
    WEB --> APACHE
    EMAIL --> DJANGO_EMAIL
    APACHE --> DJANGO
    DJANGO --> UPLOAD
    DJANGO --> PARSER
    DJANGO --> ANALYZER
    DJANGO --> REPORT
    DJANGO --> EMAIL_SVC
    
    UPLOAD --> SQLITE
    PARSER --> SQLITE
    ANALYZER --> SQLITE
    REPORT --> SQLITE
    
    UPLOAD --> FILES
    REPORT --> FILES
    
    EMAIL_SVC --> DJANGO_EMAIL
    
    %% Системные соединения
    DJANGO --> RSYSLOG
    DJANGO --> AUDIT
    
    %% Безопасность
    SELINUX -.-> DJANGO
    SELINUX -.-> SQLITE
    SELINUX -.-> FILES
    FIREWALL -.-> APACHE

    %% Стили
    classDef clientStyle fill:#e1f5fe
    classDef webStyle fill:#f3e5f5
    classDef appStyle fill:#e8f5e8
    classDef dataStyle fill:#fff3e0
    classDef systemStyle fill:#fce4ec
    classDef securityStyle fill:#ffebee

    class WEB,EMAIL clientStyle
    class APACHE webStyle
    class DJANGO,UPLOAD,PARSER,ANALYZER,REPORT,EMAIL_SVC appStyle
    class SQLITE,FILES dataStyle
    class DJANGO_EMAIL,RSYSLOG,AUDIT,FIREWALL systemStyle
    class SELINUX securityStyle
            </div>
        </div>

        <div id="deployment" class="diagram-section" style="display:none;">
            <div class="diagram-title">2. Диаграмма развертывания</div>
            <div class="description">
                Упрощенная архитектура развертывания на одном основном сервере РЕДОС 7.3. 
                Показывает размещение Django приложения и системных сервисов.
            </div>
            <div class="mermaid">
graph TB
    %% Внешняя сеть
    subgraph "Внешняя сеть"
        INTERNET[Интернет]
        ADMIN[Администратор]
        MANAGER[Руководитель]
        VIEWER[Пользователь]
    end

    %% Основной сервер
    subgraph "Основной сервер РЕДОС 7.3"
        subgraph "Django Приложение"
            DJANGO_SERVER[РЕДОС 7.3 Server<br/>Apache HTTP Server<br/>Django Application<br/>SQLite Database<br/>File Storage<br/>Django Email Backend<br/>SELinux Enforcing]
        end
        
        subgraph "Системные сервисы"
            SYSTEM_SERVICES[РЕДОС 7.3<br/>rsyslog<br/>auditd<br/>firewalld<br/>Базовые сервисы]
        end
    end

    %% Сетевая инфраструктура
    subgraph "Сетевая инфраструктура"
        SWITCH[Коммутатор]
        ROUTER[Маршрутизатор]
        FIREWALL[Маршрутизатор с файрволом]
    end

    %% Соединения
    INTERNET --> FIREWALL
    ADMIN --> FIREWALL
    MANAGER --> FIREWALL
    VIEWER --> FIREWALL
    
    FIREWALL --> ROUTER
    ROUTER --> SWITCH
    SWITCH --> DJANGO_SERVER
    SWITCH --> SYSTEM_SERVICES

    %% Безопасность
    subgraph "Безопасность"
        SELINUX_NET[SELinux Policies<br/>Mandatory Access Control]
        AUDIT_NET[auditd Logging<br/>Security Audit]
        FIREWALL_NET[firewalld<br/>Network Security]
    end

    %% Стили
    classDef externalStyle fill:#e3f2fd
    classDef serverStyle fill:#f3e5f5
    classDef networkStyle fill:#fff3e0
    classDef securityStyle fill:#ffebee

    class INTERNET,ADMIN,MANAGER,VIEWER externalStyle
    class DJANGO_SERVER,SYSTEM_SERVICES serverStyle
    class SWITCH,ROUTER,FIREWALL networkStyle
    class SELINUX_NET,AUDIT_NET,FIREWALL_NET securityStyle
            </div>
        </div>

        <div id="dataflow" class="diagram-section" style="display:none;">
            <div class="diagram-title">3. Потоки данных в системе</div>
            <div class="description">
                Последовательность операций от загрузки документа до отправки отчета по email. 
                Показывает синхронную обработку через Django и взаимодействие компонентов.
            </div>
            <div class="mermaid">
sequenceDiagram
    participant U as Пользователь
    participant W as Веб-интерфейс
    participant A as Apache
    participant D as Django
    participant DB as SQLite
    participant F as Файловое хранилище
    participant E as Django Email

    %% Загрузка документа
    U->>W: Загружает .docx файл
    W->>A: POST /upload
    A->>D: Передает файл
    D->>D: Валидация файла
    D->>DB: Сохраняет метаданные документа
    D->>F: Сохраняет файл
    D-->>A: Возвращает результат
    A-->>W: Статус загрузки
    W-->>U: Подтверждение загрузки

    %% Парсинг документа
    U->>W: Запускает парсинг
    W->>A: POST /parse
    A->>D: Передает ID документа
    D->>F: Читает файл
    D->>D: Парсинг .docx (python-docx)
    D->>D: Извлечение текста и таблиц
    D->>D: Нормализация данных
    D->>DB: Сохраняет структурированные данные
    D-->>A: Возвращает результат
    A-->>W: Статус парсинга
    W-->>U: Парсинг завершен

    %% Анализ изменений
    U->>W: Запускает сравнение
    W->>A: POST /compare
    A->>D: Передает параметры
    D->>DB: Получает базовый документ
    D->>DB: Получает сравниваемый документ
    D->>D: Сравнение текста (diff-match-patch)
    D->>D: Анализ таблиц
    D->>D: Выявление изменений
    D->>DB: Сохраняет результаты анализа
    D-->>A: Возвращает результат
    A-->>W: Анализ завершен
    W-->>U: Результаты готовы

    %% Генерация отчета
    U->>W: Запускает генерацию отчета
    W->>A: POST /generate_report
    A->>D: Передает ID анализа
    D->>DB: Получает результаты анализа
    D->>D: Генерация PDF отчета (ReportLab)
    D->>F: Сохраняет отчет
    D->>DB: Обновляет статус отчета
    D-->>A: Возвращает результат
    A-->>W: Отчет создан
    W-->>U: Отчет готов

    %% Отправка email
    D->>E: Запускает отправку email
    E->>DB: Получает данные отчета
    E->>F: Читает файл отчета
    E->>E: Отправляет email с вложением
    E->>DB: Обновляет статус отправки
    E-->>D: Подтверждение отправки
    D-->>A: Уведомление о готовности
    A-->>W: Email отправлен
    W-->>U: Email с отчетом получен
            </div>
        </div>
    </div>

    <script>
        // Инициализация Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            }
        });

        // Функции управления отображением
        function showAll() {
            document.getElementById('architecture').style.display = 'block';
            document.getElementById('deployment').style.display = 'block';
            document.getElementById('dataflow').style.display = 'block';
            updateButtons();
        }

        function hideAll() {
            document.getElementById('architecture').style.display = 'none';
            document.getElementById('deployment').style.display = 'none';
            document.getElementById('dataflow').style.display = 'none';
            updateButtons();
        }

        function toggleDiagram(id) {
            const element = document.getElementById(id);
            if (element.style.display === 'none') {
                element.style.display = 'block';
            } else {
                element.style.display = 'none';
            }
            updateButtons();
        }

        function updateButtons() {
            // Обновление стилей кнопок в зависимости от видимости диаграмм
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                if (button.textContent !== 'Показать все' && button.textContent !== 'Скрыть все') {
                    button.classList.remove('active');
                }
            });
        }
    </script>
</body>
</html>
