{% extends 'base/base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
            <div class="btn-group" role="group">
                <a href="{% url 'users:admin_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                </a>
                <a href="{% url 'users:admin_application_settings' %}" class="btn btn-info">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                </a>
                <a href="{% url 'users:admin_server_settings' %}" class="btn btn-secondary">
                    <i class="fas fa-server"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
                </a>
                <a href="{% url 'users:admin_bulk_delete_documents' %}" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i> –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã
                </a>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-users fa-2x text-primary mb-2"></i>
                        <h5 class="card-title">{{ total_users }}</h5>
                        <p class="card-text text-muted">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-user-check fa-2x text-success mb-2"></i>
                        <h5 class="card-title">{{ active_users }}</h5>
                        <p class="card-text text-muted">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-user-shield fa-2x text-warning mb-2"></i>
                        <h5 class="card-title">{{ admin_users }}</h5>
                        <p class="card-text text-muted">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <i class="fas fa-user-plus fa-2x text-info mb-2"></i>
                        <h5 class="card-title">{{ recent_users }}</h5>
                        <p class="card-text text-muted">–ù–æ–≤—ã—Ö –∑–∞ 30 –¥–Ω–µ–π</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫
                </h5>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-4">
                        <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                        <input type="text" class="form-control" id="search" name="search" 
                               value="{{ search_query }}" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, email...">
                    </div>
                    <div class="col-md-3">
                        <label for="role" class="form-label">–†–æ–ª—å</label>
                        <select class="form-select" id="role" name="role">
                            <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                            <option value="viewer" {% if role_filter == 'viewer' %}selected{% endif %}>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                            <option value="manager" {% if role_filter == 'manager' %}selected{% endif %}>–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                            <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                        <select class="form-select" id="status" name="status">
                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        {% if users %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                        <span class="badge bg-secondary ms-2">{{ users|length }}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 15%;">
                                        <i class="fas fa-user"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                    </th>
                                    <th style="width: 20%;">
                                        <i class="fas fa-envelope"></i> Email
                                    </th>
                                    <th style="width: 10%;">
                                        <i class="fas fa-user-tag"></i> –†–æ–ª—å
                                    </th>
                                    <th style="width: 10%;">
                                        <i class="fas fa-toggle-on"></i> –°—Ç–∞—Ç—É—Å
                                    </th>
                                    <th style="width: 15%;">
                                        <i class="fas fa-calendar"></i> –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                                    </th>
                                    <th style="width: 15%;">
                                        <i class="fas fa-clock"></i> –ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥
                                    </th>
                                    <th style="width: 15%;">
                                        <i class="fas fa-cogs"></i> –î–µ–π—Å—Ç–≤–∏—è
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_obj in users %}
                                <tr class="{% if not user_obj.is_active %}table-secondary{% endif %}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                                                {% if user_obj.first_name %}
                                                    {{ user_obj.first_name|first }}{{ user_obj.last_name|first }}
                                                {% else %}
                                                    {{ user_obj.username|first|upper }}
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ user_obj.username }}</strong>
                                                {% if user_obj.first_name or user_obj.last_name %}
                                                    <br>
                                                    <small class="text-muted">
                                                        {{ user_obj.first_name }} {{ user_obj.last_name }}
                                                    </small>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <small>{{ user_obj.email|default:"‚Äî" }}</small>
                                    </td>
                                    <td>
                                        {% if user_obj.is_superuser %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-crown"></i> –°—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                            </span>
                                        {% elif user_obj.role == 'admin' %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-user-shield"></i> –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                                            </span>
                                        {% elif user_obj.role == 'manager' %}
                                            <span class="badge bg-info">
                                                <i class="fas fa-user-tie"></i> –ú–µ–Ω–µ–¥–∂–µ—Ä
                                            </span>
                                        {% else %}
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-user"></i> –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user_obj.is_active %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check"></i> –ê–∫—Ç–∏–≤–µ–Ω
                                            </span>
                                        {% else %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-times"></i> –ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ user_obj.date_joined|date:"d.m.Y H:i" }}</small>
                                    </td>
                                    <td>
                                        {% if user_obj.last_login %}
                                            <small>{{ user_obj.last_login|date:"d.m.Y H:i" }}</small>
                                        {% else %}
                                            <small class="text-muted">–ù–∏–∫–æ–≥–¥–∞</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'users:admin_detail' user_obj.pk %}" class="btn btn-outline-primary" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'users:admin_edit' user_obj.pk %}" class="btn btn-outline-warning" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if user_obj != request.user %}
                                                <a href="{% url 'users:admin_toggle_active' user_obj.pk %}" 
                                                   class="btn btn-outline-{% if user_obj.is_active %}danger{% else %}success{% endif %}" 
                                                   title="{% if user_obj.is_active %}–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% else %}–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% endif %}"
                                                   onclick="return confirm('{% if user_obj.is_active %}–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% else %}–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% endif %} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')">
                                                    <i class="fas fa-toggle-{% if user_obj.is_active %}off{% else %}on{% endif %}"></i>
                                                </a>
                                                <a href="{% url 'users:admin_delete' user_obj.pk %}" class="btn btn-outline-danger" title="–£–¥–∞–ª–∏—Ç—å">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
            {% if is_paginated %}
                <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ page_obj.paginator.num_pages }}
                            </span>
                        </li>

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if role_filter %}&role={{ role_filter }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-users fa-3x text-muted"></i>
                </div>
                <h4 class="text-muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                <a href="{% url 'users:admin_list' %}" class="btn btn-primary">
                    <i class="fas fa-refresh"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </a>
            </div>
        {% endif %}
    </div>
</div>

<style>
.avatar-sm {
    width: 40px;
    height: 40px;
    font-size: 14px;
    font-weight: bold;
}
</style>
{% endblock %}
