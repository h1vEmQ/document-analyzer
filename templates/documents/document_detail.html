{% extends 'base/base.html' %}

{% block title %}{{ document.title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üìÑ {{ document.title }}</h1>
            <div class="btn-group" role="group">
                <a href="{% url 'documents:version_upload' document.pk %}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
                </a>
                {% if document.get_version_count > 1 %}
                    <a href="{% url 'documents:version_history' document.pk %}" class="btn btn-info">
                        <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π
                    </a>
                {% endif %}
                {% if document.status == 'uploaded' or document.status == 'error' %}
                    <a href="{% url 'documents:parse' document.pk %}" class="btn btn-success">
                        <i class="fas fa-cog"></i> 
                        {% if document.status == 'error' %}–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É{% else %}–û–±—Ä–∞–±–æ—Ç–∞—Ç—å{% endif %}
                    </a>
                {% endif %}
                <a href="{% url 'documents:delete' document.pk %}" 
                   class="btn btn-danger"
                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </a>
            </div>
        </div>

        <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –≤–µ—Ä—Å–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π) -->
        {% if document.get_version_count > 1 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-code-branch"></i> –í—ã–±–æ—Ä –≤–µ—Ä—Å–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="version-selector" class="form-label"><strong>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</strong></label>
                                <select id="version-selector" class="form-select" onchange="changeVersion(this.value)">
                                    {% for version in document.get_version_history %}
                                        <option value="{{ version.id }}" {% if version.id == document.id %}selected{% endif %}>
                                            v{{ version.version }} - {{ version.upload_date|date:"d.m.Y H:i" }}
                                            {% if version.is_latest_version %}(–ü–æ—Å–ª–µ–¥–Ω—è—è){% endif %}
                                            {% if version.has_key_points %}üîë{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏—è—Ö:</strong></label>
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i>
                                    –í—Å–µ–≥–æ –≤–µ—Ä—Å–∏–π: <strong>{{ document.get_version_count }}</strong><br>
                                    {% if document.is_latest_version %}
                                        –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ <strong>–ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é</strong>
                                    {% else %}
                                        –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ <strong>—Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é</strong>. 
                                        {% with latest_version=document.get_latest_version %}
                                            {% if latest_version and latest_version.id %}
                                                <a href="{% url 'documents:detail' latest_version.id %}" class="alert-link">
                                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
                                                </a>
                                            {% else %}
                                                <span class="text-muted">–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                    <br><small>üîë = –≤–µ—Ä—Å–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏</small>
                                    {% with versions_with_key_points=document.get_versions_with_key_points %}
                                        {% if versions_with_key_points.count > 0 %}
                                            <br><small class="text-success">
                                                <i class="fas fa-key"></i> {{ versions_with_key_points.count }} –∏–∑ {{ document.get_version_count }} –≤–µ—Ä—Å–∏–π –∏–º–µ—é—Ç –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
                                            </small>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong></td>
                                <td>{{ document.title }}</td>
                            </tr>
                            <tr>
                                <td><strong>–§–∞–π–ª:</strong></td>
                                <td>{{ document.filename }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏—è:</strong></td>
                                <td>{{ document.version }}</td>
                            </tr>
                            <tr>
                                <td><strong>–†–∞–∑–º–µ—Ä:</strong></td>
                                <td>{{ document.get_file_size_mb }} –ú–ë</td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                <td>
                                    {% if document.status == 'uploaded' %}
                                        <span class="badge bg-warning">–ó–∞–≥—Ä—É–∂–µ–Ω</span>
                                    {% elif document.status == 'processing' %}
                                        <span class="badge bg-info">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</span>
                                    {% elif document.status == 'processed' %}
                                        <span class="badge bg-success">–û–±—Ä–∞–±–æ—Ç–∞–Ω</span>
                                    {% elif document.status == 'error' %}
                                        <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if document.get_version_count > 1 %}
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏–π:</strong></td>
                                <td>
                                    <span class="badge bg-info">{{ document.get_version_count }}</span>
                                    {% if not document.is_latest_version %}
                                        <span class="badge bg-secondary ms-1">–ù–µ –ø–æ—Å–ª–µ–¥–Ω—è—è</span>
                                    {% else %}
                                        <span class="badge bg-success ms-1">–ü–æ—Å–ª–µ–¥–Ω—è—è</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if document.version_notes %}
                            <tr>
                                <td><strong>–ó–∞–º–µ—Ç–∫–∏ –∫ –≤–µ—Ä—Å–∏–∏:</strong></td>
                                <td>{{ document.version_notes }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td><strong>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong></td>
                                <td>{{ document.upload_date|date:"d.m.Y H:i" }}</td>
                            </tr>
                            {% if document.processed_date %}
                                <tr>
                                    <td><strong>–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</strong></td>
                                    <td>{{ document.processed_date|date:"d.m.Y H:i" }}</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <td><strong>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞:</strong></td>
                                <td><code>{{ document.checksum|truncatechars:20 }}</code></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å error) -->
                {% if document.status == 'error' %}
                <div class="card mt-3">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-info-circle"></i> –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:</h6>
                            <p class="mb-2">–î–æ–∫—É–º–µ–Ω—Ç –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π.</p>
                            
                            <h6><i class="fas fa-tools"></i> –ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</h6>
                            <ul class="mb-3">
                                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"</strong> –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (.docx)</li>
                                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10 –ú–ë</li>
                            </ul>
                            
                            <div class="d-grid">
                                <a href="{% url 'documents:parse' document.pk %}" class="btn btn-success">
                                    <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
                                </a>
                            </div>
                        </div>
                        
                        {% if document.processing_error %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-bug"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ:</h6>
                            <pre class="mb-0 small">{{ document.processing_error }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ</h5>
                    </div>
                    <div class="card-body">
                        {% if document.has_content %}
                            <h6>–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h6>
                            <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                <pre>{{ document.content_text|truncatewords:100 }}</pre>
                            </div>
                            
                            {% if document.get_parsed_sections_count > 0 %}
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>–†–∞–∑–¥–µ–ª–æ–≤:</strong> {{ document.get_parsed_sections_count }}
                                    </small>
                                </div>
                            {% endif %}
                            
                            {% if document.get_parsed_tables_count > 0 %}
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <strong>–¢–∞–±–ª–∏—Ü:</strong> {{ document.get_parsed_tables_count }}
                                    </small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">–î–æ–∫—É–º–µ–Ω—Ç –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –°–µ–∫—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>üîë –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã 
                            {% if document.get_version_count > 1 %}
                                <small class="text-muted">(–≤–µ—Ä—Å–∏—è {{ document.version }})</small>
                            {% endif %}
                        </h5>
                        {% if document.has_content and document.status == 'processed' %}
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="generateKeyPoints({{ document.pk }})"
                                        {% if document.has_key_points %}disabled{% endif %}>
                                    <i class="fas fa-magic"></i> 
                                    {% if document.has_key_points %}–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã{% else %}–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        onclick="testKeyPoints({{ document.pk }})">
                                    <i class="fas fa-bug"></i> –¢–µ—Å—Ç
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if document.has_key_points %}
                            <div id="key-points-content">
                                {% for point in document.get_key_points %}
                                    {% if point.point %}
                                        <div class="mb-3 p-3 border rounded {% if point.importance == 'high' %}bg-warning bg-opacity-10{% elif point.importance == 'medium' %}bg-info bg-opacity-10{% else %}bg-light{% endif %}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-2">
                                                        {% if point.importance == 'high' %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% elif point.importance == 'medium' %}
                                                            <i class="fas fa-circle text-info"></i>
                                                        {% else %}
                                                            <i class="fas fa-dot-circle text-secondary"></i>
                                                        {% endif %}
                                                        {{ point.point }}
                                                    </h6>
                                                    {% if point.category %}
                                                        <span class="badge bg-secondary">{{ point.category }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if document.get_key_points_summary %}
                                    <div class="mt-3 p-3 bg-primary bg-opacity-10 border rounded">
                                        <h6><i class="fas fa-file-alt"></i> –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ:</h6>
                                        <p class="mb-0">{{ document.get_key_points_summary }}</p>
                                    </div>
                                {% endif %}
                                
                                {% if document.key_points_generated_date %}
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {{ document.key_points_generated_date|date:"d.m.Y H:i" }}
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div id="key-points-placeholder" class="text-center text-muted">
                                {% if document.has_content and document.status == 'processed' %}
                                    <p><i class="fas fa-lightbulb fa-3x mb-3"></i></p>
                                    <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞</p>
                                {% else %}
                                    <p><i class="fas fa-info-circle fa-2x mb-3"></i></p>
                                    <p>–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</p>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div id="key-points-loading" class="text-center" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                            </div>
                            <p class="mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã...</p>
                            <small class="text-muted">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 90 —Å–µ–∫—É–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –º–æ–¥–µ–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if document.sections.all %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìë –†–∞–∑–¥–µ–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="sectionsAccordion">
                                {% for section in document.sections.all %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ section.id }}">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse{{ section.id }}">
                                                {{ section.title }} (–£—Ä–æ–≤–µ–Ω—å {{ section.level }})
                                            </button>
                                        </h2>
                                        <div id="collapse{{ section.id }}" class="accordion-collapse collapse" 
                                             data-bs-parent="#sectionsAccordion">
                                            <div class="accordion-body">
                                                {{ section.content|truncatewords:50 }}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> –î–µ–π—Å—Ç–≤–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" role="group">
                            <a href="{% url 'documents:rename' document.pk %}" class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
                            </a>
                            <a href="{% url 'documents:version_upload' document.pk %}" class="btn btn-primary">
                                <i class="fas fa-upload"></i> –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
                            </a>
                            {% if document.get_version_count > 1 %}
                                <a href="{% url 'documents:version_history' document.pk %}" class="btn btn-info">
                                    <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π
                                </a>
                            {% endif %}
                            {% if document.status == 'uploaded' %}
                                <a href="{% url 'documents:parse' document.pk %}" class="btn btn-success">
                                    <i class="fas fa-cog"></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å
                                </a>
                            {% endif %}
                            <a href="{% url 'documents:delete' document.pk %}" 
                               class="btn btn-danger"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function changeVersion(versionId) {
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    window.location.href = '/documents/' + versionId + '/';
}

function generateKeyPoints(documentId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('key-points-loading').style.display = 'block';
    document.getElementById('key-points-placeholder').style.display = 'none';
    document.getElementById('key-points-content').style.display = 'none';
    
    // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
    fetch(`/documents/${documentId}/generate-key-points/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
        signal: AbortSignal.timeout(90000) // 90 —Å–µ–∫—É–Ω–¥
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
            window.location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById('key-points-loading').style.display = 'none';
            document.getElementById('key-points-placeholder').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.name === 'TimeoutError') {
            alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (90 —Å–µ–∫—É–Ω–¥). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å.');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: ' + error.message);
        }
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        document.getElementById('key-points-loading').style.display = 'none';
        document.getElementById('key-points-placeholder').style.display = 'block';
    });
}

function testKeyPoints(documentId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('key-points-loading').style.display = 'block';
    document.getElementById('key-points-placeholder').style.display = 'none';
    document.getElementById('key-points-content').style.display = 'none';
    
    // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å
    fetch(`/documents/${documentId}/test-key-points/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('key-points-loading').style.display = 'none';
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞
            let testInfo = `
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</h6>
                    <p><strong>–°—Ç–∞—Ç—É—Å –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> ${data.status_info.document_status}</p>
                    <p><strong>–°–æ–¥–µ—Ä–∂–∏–º–æ–µ:</strong> ${data.status_info.has_content ? '–ï—Å—Ç—å (' + data.status_info.content_length + ' —Å–∏–º–≤–æ–ª–æ–≤)' : '–ù–µ—Ç'}</p>
                    <p><strong>Ollama –¥–æ—Å—Ç—É–ø–µ–Ω:</strong> ${data.ollama_info.available ? '–î–∞' : '–ù–µ—Ç'}</p>
                    <p><strong>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:</strong> ${data.ollama_info.current_model}</p>
                    <p><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:</strong> ${data.ollama_info.available_models.join(', ')}</p>
                    ${data.test_result ? `
                        <p><strong>–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong> ${data.test_result.success ? '–£—Å–ø–µ—à–Ω–æ' : '–û—à–∏–±–∫–∞: ' + data.test_result.error}</p>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('key-points-placeholder').innerHTML = testInfo;
            document.getElementById('key-points-placeholder').style.display = 'block';
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            document.getElementById('key-points-placeholder').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');
        document.getElementById('key-points-loading').style.display = 'none';
        document.getElementById('key-points-placeholder').style.display = 'block';
    });
}
</script>
{% endblock %}
