{% extends 'base/base.html' %}

{% block title %}{{ document.title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üìÑ {{ document.title }}
                {% if document.get_version_count > 1 %}
                    <small class="text-muted">(–≤–µ—Ä—Å–∏—è {{ document.version }})</small>
                {% endif %}
            </h1>
            <div class="btn-group" role="group">
                <a href="{% url 'documents:version_upload' document.pk %}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
                </a>
                {% if document.get_version_count > 1 %}
                    <a href="{% url 'documents:version_history' document.pk %}" class="btn btn-info">
                        <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π
                    </a>
                {% endif %}
                {% if document.status == 'uploaded' or document.status == 'error' %}
                    <a href="{% url 'documents:parse' document.pk %}" class="btn btn-success">
                        <i class="fas fa-cog"></i> 
                        {% if document.status == 'error' %}–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É{% else %}–û–±—Ä–∞–±–æ—Ç–∞—Ç—å{% endif %}
                    </a>
                {% endif %}
                <a href="{% url 'documents:delete' document.pk %}" 
                   class="btn btn-danger"
                   onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')">
                    <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                </a>
            </div>
        </div>

        <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –≤–µ—Ä—Å–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π) -->
        {% if document.get_version_count > 1 %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-code-branch"></i> –í—ã–±–æ—Ä –≤–µ—Ä—Å–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="version-selector" class="form-label"><strong>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</strong></label>
                                <select id="version-selector" class="form-select" onchange="changeVersion(this.value)">
                                    {% for version in document.get_version_history %}
                                        <option value="{{ version.id }}" {% if version.id == document.id %}selected{% endif %}>
                                            v{{ version.version }} - {{ version.upload_date|date:"d.m.Y H:i" }}
                                            {% if version.is_latest_version %}(–ü–æ—Å–ª–µ–¥–Ω—è—è){% endif %}
                                            {% if version.has_key_points %}üîë{% endif %}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label"><strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏—è—Ö:</strong></label>
                                <div class="alert alert-info mb-0">
                                    <i class="fas fa-info-circle"></i>
                                    –í—Å–µ–≥–æ –≤–µ—Ä—Å–∏–π: <strong>{{ document.get_version_count }}</strong><br>
                                    {% if document.is_latest_version %}
                                        –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ <strong>–ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é</strong>
                                    {% else %}
                                        –í—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ <strong>—Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é</strong>. 
                                        {% with latest_version=document.get_latest_version %}
                                            {% if latest_version and latest_version.id %}
                                                <a href="{% url 'documents:detail' latest_version.id %}" class="alert-link">
                                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
                                                </a>
                                            {% else %}
                                                <span class="text-muted">–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% endif %}
                                    <br><small>üîë = –≤–µ—Ä—Å–∏—è —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏</small>
                    {% with table_analyses=document.table_analyses.all %}
                        {% if table_analyses %}
                            <br><small class="text-info">
                                <i class="fas fa-table"></i> {{ table_analyses.count }} –∞–Ω–∞–ª–∏–∑–æ–≤ —Ç–∞–±–ª–∏—Ü –≤—ã–ø–æ–ª–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                            </small>
                        {% endif %}
                    {% endwith %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–µ</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong></td>
                                <td>{{ document.title }}</td>
                            </tr>
                            <tr>
                                <td><strong>–§–∞–π–ª:</strong></td>
                                <td>{{ document.filename }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏—è:</strong></td>
                                <td>{{ document.version }}</td>
                            </tr>
                            <tr>
                                <td><strong>–†–∞–∑–º–µ—Ä:</strong></td>
                                <td>{{ document.get_file_size_mb }} –ú–ë</td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                <td>
                                    {% if document.status == 'uploaded' %}
                                        <span class="badge bg-warning">–ó–∞–≥—Ä—É–∂–µ–Ω</span>
                                    {% elif document.status == 'processing' %}
                                        <span class="badge bg-info">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</span>
                                    {% elif document.status == 'processed' %}
                                        <span class="badge bg-success">–û–±—Ä–∞–±–æ—Ç–∞–Ω</span>
                                    {% elif document.status == 'error' %}
                                        <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% if document.get_version_count > 1 %}
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏–π:</strong></td>
                                <td>
                                    <span class="badge bg-info">{{ document.get_version_count }}</span>
                                    {% if not document.is_latest_version %}
                                        <span class="badge bg-secondary ms-1">–ù–µ –ø–æ—Å–ª–µ–¥–Ω—è—è</span>
                                    {% else %}
                                        <span class="badge bg-success ms-1">–ü–æ—Å–ª–µ–¥–Ω—è—è</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endif %}
                            {% if document.version_notes %}
                            <tr>
                                <td><strong>–ó–∞–º–µ—Ç–∫–∏ –∫ –≤–µ—Ä—Å–∏–∏:</strong></td>
                                <td>{{ document.version_notes }}</td>
                            </tr>
                            {% endif %}
                            <tr>
                                <td><strong>–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong></td>
                                <td>{{ document.upload_date|date:"d.m.Y H:i" }}</td>
                            </tr>
                            {% if document.processed_date %}
                                <tr>
                                    <td><strong>–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:</strong></td>
                                    <td>{{ document.processed_date|date:"d.m.Y H:i" }}</td>
                                </tr>
                            {% endif %}
                            <tr>
                                <td><strong>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞:</strong></td>
                                <td><code>{{ document.checksum|truncatechars:20 }}</code></td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ (–µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å error) -->
                {% if document.status == 'error' %}
                <div class="card mt-3">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-triangle"></i> –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-danger">
                            <h6><i class="fas fa-info-circle"></i> –ß—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ:</h6>
                            <p class="mb-2">–î–æ–∫—É–º–µ–Ω—Ç –±—ã–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π.</p>
                            
                            <h6><i class="fas fa-tools"></i> –ß—Ç–æ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:</h6>
                            <ul class="mb-3">
                                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É"</strong> –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏</li>
                                <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ–∞–π–ª –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω –∏ –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (.docx)</li>
                                <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10 –ú–ë</li>
                            </ul>
                            
                            <div class="d-grid">
                                <a href="{% url 'documents:parse' document.pk %}" class="btn btn-success">
                                    <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
                                </a>
                            </div>
                        </div>
                        
                        {% if document.processing_error %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-bug"></i> –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—à–∏–±–∫–µ:</h6>
                            <pre class="mb-0 small">{{ document.processing_error }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä –°–æ–¥–µ—Ä–∂–∏–º–æ–µ</h5>
                    </div>
                    <div class="card-body">
                        {% if document.has_content %}
                            <h6>–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:</h6>
                            <div class="border p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                                <pre>{{ document.content_text|truncatewords:100 }}</pre>
                            </div>
                            
                            {% if document.get_parsed_sections_count > 0 %}
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>–†–∞–∑–¥–µ–ª–æ–≤:</strong> {{ document.get_parsed_sections_count }}
                                    </small>
                                </div>
                            {% endif %}
                            
                            {% if document.get_parsed_tables_count > 0 %}
                                <div class="mt-1">
                                    <small class="text-muted">
                                        <strong>–¢–∞–±–ª–∏—Ü:</strong> {{ document.get_parsed_tables_count }}
                                    </small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">–î–æ–∫—É–º–µ–Ω—Ç –µ—â–µ –Ω–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- –°–µ–∫—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ -->
                <div class="card mt-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>üîë –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã 
                            {% if document.get_version_count > 1 %}
                                <small class="text-muted">(–≤–µ—Ä—Å–∏—è {{ document.version }})</small>
                            {% endif %}
                        </h5>
                        <small class="text-muted">
                            <i class="fas fa-magic"></i> –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                        </small>
                        {% if document.has_content and document.status == 'processed' %}
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary" 
                                        onclick="generateKeyPoints({{ document.pk }})">
                                    <i class="fas fa-magic"></i> 
                                    {% if document.has_key_points %}–û–±–Ω–æ–≤–∏—Ç—å{% else %}–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if document.has_key_points %}
                            <div id="key-points-content">
                                {% for point in document.get_key_points %}
                                    {% if point.point %}
                                        <div class="mb-3 p-3 border rounded {% if point.importance == '–≤—ã—Å–æ–∫–∏–π' or point.importance == 'high' %}bg-warning bg-opacity-10{% elif point.importance == '—Å—Ä–µ–¥–Ω–∏–π' or point.importance == 'medium' %}bg-info bg-opacity-10{% else %}bg-light{% endif %}">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="mb-2">
                                                        {% if point.importance == '–≤—ã—Å–æ–∫–∏–π' or point.importance == 'high' %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% elif point.importance == '—Å—Ä–µ–¥–Ω–∏–π' or point.importance == 'medium' %}
                                                            <i class="fas fa-circle text-info"></i>
                                                        {% else %}
                                                            <i class="fas fa-dot-circle text-secondary"></i>
                                                        {% endif %}
                                                        {{ point.point }}
                                                    </h6>
                                                    {% if point.category %}
                                                        <span class="badge bg-secondary">{{ point.category }}</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if document.get_key_points_summary %}
                                    <div class="mt-3 p-3 bg-primary bg-opacity-10 border rounded">
                                        <h6><i class="fas fa-file-alt"></i> –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ:</h6>
                                        <p class="mb-0">{{ document.get_key_points_summary }}</p>
                                    </div>
                                {% endif %}
                                
                                {% if document.key_points_generated_date %}
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-clock"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {{ document.key_points_generated_date|date:"d.m.Y H:i" }}
                                        </small>
                                    </div>
                                {% endif %}
                            </div>
                        {% else %}
                            <div id="key-points-placeholder" class="text-center text-muted">
                                {% if document.has_content and document.status == 'processed' %}
                                    <p><i class="fas fa-lightbulb fa-3x mb-3"></i></p>
                                    <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å" –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞</p>
                                {% else %}
                                    <p><i class="fas fa-info-circle fa-2x mb-3"></i></p>
                                    <p>–°–Ω–∞—á–∞–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∞–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤</p>
                                {% endif %}
                            </div>
                        {% endif %}
                        
                            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                            <div id="key-points-loading" class="text-center" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <p class="mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã...</p>
                                <small class="text-muted">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 120 —Å–µ–∫—É–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ –º–æ–¥–µ–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏.</small>
                                <div class="mt-3">
                                    <div class="progress" style="height: 6px;">
                                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                             role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="progress-text" class="text-muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</small>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>

        {% if document.sections.all %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìë –†–∞–∑–¥–µ–ª—ã –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
                        </div>
                        <div class="card-body">
                            <div class="accordion" id="sectionsAccordion">
                                {% for section in document.sections.all %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading{{ section.id }}">
                                            <button class="accordion-button collapsed" type="button" 
                                                    data-bs-toggle="collapse" 
                                                    data-bs-target="#collapse{{ section.id }}">
                                                {{ section.title }} (–£—Ä–æ–≤–µ–Ω—å {{ section.level }})
                                            </button>
                                        </h2>
                                        <div id="collapse{{ section.id }}" class="accordion-collapse collapse" 
                                             data-bs-parent="#sectionsAccordion">
                                            <div class="accordion-body">
                                                {{ section.content|truncatewords:50 }}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
        
        <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-cogs"></i> –î–µ–π—Å—Ç–≤–∏—è</h5>
                    </div>
                    <div class="card-body">
                        <div class="btn-group" role="group">
                            <a href="{% url 'documents:rename' document.pk %}" class="btn btn-outline-primary">
                                <i class="fas fa-edit"></i> –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å
                            </a>
                            <a href="{% url 'documents:version_upload' document.pk %}" class="btn btn-primary">
                                <i class="fas fa-upload"></i> –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
                            </a>
                            {% if document.get_version_count > 1 %}
                                <a href="{% url 'documents:version_history' document.pk %}" class="btn btn-info">
                                    <i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π
                                </a>
                            {% endif %}
                            {% if document.status == 'uploaded' %}
                                <a href="{% url 'documents:parse' document.pk %}" class="btn btn-success">
                                    <i class="fas fa-cog"></i> –û–±—Ä–∞–±–æ—Ç–∞—Ç—å
                                </a>
                            {% endif %}
                            <a href="{% url 'documents:delete' document.pk %}" 
                               class="btn btn-danger"
                               onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç?')">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table"></i> –ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü {% if document.get_version_count > 1 %}<small class="text-muted">(–≤–µ—Ä—Å–∏—è {{ document.version }})</small>{% endif %}</h5>
                    <small class="text-muted">
                        <i class="fas fa-magic"></i> –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
                    </small>
                </div>
                <div class="card-body">
                    {% with table_analyses=document.table_analyses.all %}
                        {% if table_analyses %}
                            <div class="row">
                                {% for analysis in table_analyses %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card border-info">
                                            <div class="card-header bg-info bg-opacity-10">
                                                <h6 class="mb-0">
                                                    <i class="fas fa-table"></i> 
                                                    {% if analysis.table.title %}{{ analysis.table.title }}{% else %}–¢–∞–±–ª–∏—Ü–∞ {{ forloop.counter }}{% endif %}
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <small class="text-muted">–†–∞–∑–º–µ—Ä:</small><br>
                                                        <strong>{{ analysis.row_count }} √ó {{ analysis.column_count }}</strong>
                                                    </div>
                                                    <div class="col-6">
                                                        <small class="text-muted">–¢–∏–ø:</small><br>
                                                        <span class="badge {% if analysis.table_type == '—á–∏—Å–ª–æ–≤–∞—è' %}bg-success{% elif analysis.table_type == '—Å–º–µ—à–∞–Ω–Ω–∞—è' %}bg-warning{% else %}bg-secondary{% endif %}">
                                                            {{ analysis.table_type }}
                                                        </span>
                                                    </div>
                                                </div>
                                                
                                                {% if analysis.main_topic %}
                                                    <div class="mt-2">
                                                        <small class="text-muted">–¢–µ–º–∞:</small><br>
                                                        <small>{{ analysis.main_topic }}</small>
                                                    </div>
                                                {% endif %}
                                                
                                                <div class="mt-2">
                                                    <div class="progress" style="height: 8px;">
                                                        <div class="progress-bar bg-success" style="width: {{ analysis.get_fill_percentage }}%"></div>
                                                    </div>
                                                    <small class="text-muted">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å: {{ analysis.get_fill_percentage }}%</small>
                                                </div>
                                                
                                                {% if analysis.key_metrics %}
                                                    <div class="mt-2">
                                                        <small class="text-muted">–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:</small>
                                                        <ul class="list-unstyled mb-0">
                                                            {% for metric in analysis.key_metrics|slice:":3" %}
                                                                <li><small>{{ metric.name }}: <strong>{{ metric.value }}</strong></small></li>
                                                            {% endfor %}
                                                        </ul>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ -->
                            <div class="text-center mt-3">
                                {% if document.status == 'processed' %}
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="analyzeTables({{ document.id }})">
                                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü
                                    </button>
                                {% endif %}
                            </div>
                        {% else %}
                            <div class="text-center text-muted">
                                <p><i class="fas fa-table fa-3x mb-3"></i></p>
                                <p>–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω</p>
                                {% if document.status == 'processed' %}
                                    <button type="button" class="btn btn-outline-primary" onclick="analyzeTables({{ document.id }})">
                                        <i class="fas fa-chart-bar"></i> –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü
                                    </button>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endwith %}
                    
                    <div id="table-analysis-loading" class="text-center" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p class="mt-2">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—ã...</p>
                        <small class="text-muted">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–∞–±–ª–∏—Ü.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showMessage(type, message) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.style.minWidth = '300px';
    
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
    document.body.appendChild(alertDiv);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function changeVersion(versionId) {
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
    window.location.href = '/documents/' + versionId + '/';
}

function generateKeyPoints(documentId) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    document.getElementById('key-points-loading').style.display = 'block';
    document.getElementById('key-points-placeholder').style.display = 'none';
    document.getElementById('key-points-content').style.display = 'none';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    let progress = 0;
    
    // –°–∏–º—É–ª—è—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const progressInterval = setInterval(() => {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90; // –ù–µ –¥–æ—Ö–æ–¥–∏–º –¥–æ 100% –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        progressBar.style.width = progress + '%';
        
        if (progress < 20) {
            progressText.textContent = '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
        } else if (progress < 40) {
            progressText.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏...';
        } else if (progress < 60) {
            progressText.textContent = '–ê–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞...';
        } else if (progress < 80) {
            progressText.textContent = '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤...';
        } else {
            progressText.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ...';
        }
    }, 1000);
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    const stopProgress = () => {
        clearInterval(progressInterval);
        progressBar.style.width = '100%';
        progressText.textContent = '–ó–∞–≤–µ—Ä—à–µ–Ω–æ!';
    };
    
    // –î–µ–ª–∞–µ–º AJAX –∑–∞–ø—Ä–æ—Å —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
    // –í—Ä–µ–º–µ–Ω–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π endpoint –±–µ–∑ CSRF
    fetch(`/documents/${documentId}/generate-key-points-test/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        signal: AbortSignal.timeout(120000) // 120 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    })
    .then(response => {
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        return response.text(); // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
    })
    .then(text => {
        console.log('Raw response:', text);
        
        try {
            const data = JSON.parse(text);
            console.log('Parsed data:', data);
            
            if (data.success) {
                console.log('Generation successful, updating content...');
                stopProgress();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                setTimeout(() => {
                    window.location.reload();
                }, 1000); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            } else {
                console.error('Generation failed:', data.error);
                stopProgress();
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                document.getElementById('key-points-loading').style.display = 'none';
                document.getElementById('key-points-placeholder').style.display = 'block';
            }
        } catch (parseError) {
            console.error('JSON parse error:', parseError);
            console.error('Response text:', text);
            stopProgress();
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            document.getElementById('key-points-loading').style.display = 'none';
            document.getElementById('key-points-placeholder').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        stopProgress();
        if (error.name === 'TimeoutError') {
            alert('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (120 —Å–µ–∫—É–Ω–¥). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—É—é –º–æ–¥–µ–ª—å.');
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤: ' + error.message);
        }
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        document.getElementById('key-points-loading').style.display = 'none';
        document.getElementById('key-points-placeholder').style.display = 'block';
    });
}

function analyzeTables(documentId) {
    console.log('–ù–∞—á–∏–Ω–∞–µ–º –∞–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:', documentId);
    
    document.getElementById('table-analysis-loading').style.display = 'block';
    
    fetch(`/documents/${documentId}/analyze-tables/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        signal: AbortSignal.timeout(30000) // 30 —Å–µ–∫—É–Ω–¥
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Analysis result:', data);
        if (data.success) {
            showMessage('success', '–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
            setTimeout(() => { window.location.reload(); }, 1000);
        } else {
            showMessage('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–∞–±–ª–∏—Ü: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.name === 'TimeoutError') {
            showMessage('error', '–ê–Ω–∞–ª–∏–∑ —Ç–∞–±–ª–∏—Ü –ø—Ä–µ–≤—ã—Å–∏–ª –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30 —Å–µ–∫—É–Ω–¥).');
        } else {
            showMessage('error', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ç–∞–±–ª–∏—Ü: ' + error.message);
        }
    })
    .finally(() => {
        document.getElementById('table-analysis-loading').style.display = 'none';
    });
}
</script>
{% endblock %}
