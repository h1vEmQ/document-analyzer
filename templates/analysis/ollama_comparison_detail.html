{% extends 'base/base.html' %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é - {{ comparison.title }}{% endblock %}

{% block extra_css %}
<style>
    .analysis-result {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .similarities, .differences, .recommendations {
        margin-bottom: 20px;
    }
    .difference-item {
        background-color: white;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 4px solid #007bff;
    }
    .difference-item.high {
        border-left-color: #dc3545;
    }
    .difference-item.medium {
        border-left-color: #ffc107;
    }
    .difference-item.low {
        border-left-color: #28a745;
    }
    .sentiment-analysis {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
    }
    .sentiment-card {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        flex: 1;
        text-align: center;
    }
    .sentiment-positive {
        border-left: 4px solid #28a745;
    }
    .sentiment-negative {
        border-left: 4px solid #dc3545;
    }
    .sentiment-neutral {
        border-left: 4px solid #6c757d;
    }
    .key-points {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }
    .key-points-card {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
    }
    .key-point-item {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 8px;
        border-left: 3px solid #007bff;
    }
    .key-point-item.high {
        border-left-color: #dc3545;
    }
    .key-point-item.medium {
        border-left-color: #ffc107;
    }
    .key-point-item.low {
        border-left-color: #28a745;
    }
    .raw-response {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üß† {{ comparison.title }}</h2>
            <div class="d-flex gap-2">
                {% if latest_report %}
                    <a href="{% url 'reports:detail' latest_report.id %}" class="btn btn-success d-flex flex-column align-items-center justify-content-center" style="min-width: 140px; height: 60px;">
                        <i class="fas fa-eye mb-1" style="font-size: 1.2em;"></i>
                        <span style="font-size: 0.75em;">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç ({{ latest_report.format|upper }})</span>
                    </a>
                    <a href="{{ latest_report.file.url }}" class="btn btn-primary d-flex flex-column align-items-center justify-content-center" target="_blank" style="min-width: 120px; height: 60px;">
                        <i class="fas fa-download mb-1" style="font-size: 1.2em;"></i>
                        <span style="font-size: 0.85em;">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç</span>
                    </a>
                {% elif comparison.reports.exists %}
                    <a href="{% url 'reports:list' %}" class="btn btn-info d-flex flex-column align-items-center justify-content-center" style="min-width: 140px; height: 60px;">
                        <i class="fas fa-file-alt mb-1" style="font-size: 1.2em;"></i>
                        <span style="font-size: 0.75em;">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –æ—Ç—á–µ—Ç—ã ({{ comparison.reports.count }})</span>
                    </a>
                {% else %}
                    <a href="{% url 'reports:generate' comparison.id %}" class="btn btn-success d-flex flex-column align-items-center justify-content-center" style="min-width: 120px; height: 60px;">
                        <i class="fas fa-file-alt mb-1" style="font-size: 1.2em;"></i>
                        <span style="font-size: 0.85em;">–°–æ–∑–¥–∞—Ç—å –æ—Ç—á–µ—Ç</span>
                    </a>
                {% endif %}
                <a href="{% url 'analysis:ollama_create' %}" class="btn btn-primary d-flex flex-column align-items-center justify-content-center" style="min-width: 120px; height: 60px;">
                    <i class="fas fa-plus mb-1" style="font-size: 1.2em;"></i>
                    <span style="font-size: 0.85em;">–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</span>
                </a>
                <a href="{% url 'analysis:list' %}" class="btn btn-secondary d-flex flex-column align-items-center justify-content-center" style="min-width: 120px; height: 60px;">
                    <i class="fas fa-arrow-left mb-1" style="font-size: 1.2em;"></i>
                    <span style="font-size: 0.85em;">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</span>
                </a>
            </div>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞ -->
        {% if comparison.status == 'pending' or comparison.status == 'processing' %}
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-3" role="status">
                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </div>
                <div>
                    <strong>
                        {% if comparison.status == 'pending' %}
                            –ê–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É
                        {% elif comparison.status == 'processing' %}
                            –ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
                        {% endif %}
                    </strong>
                    <div class="text-muted small mt-1">
                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.
                    </div>
                </div>
            </div>
        </div>
        {% elif comparison.status == 'error' %}
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞</strong>
            <div class="text-muted small mt-1">
                –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑.
            </div>
        </div>
        {% endif %}

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–Ω–∞–ª–∏–∑–µ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–Ω–∞–ª–∏–∑–µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>–ë–∞–∑–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç:</strong> {{ comparison.base_document.title }} (v{{ comparison.base_document.version }})</p>
                        <p><strong>–°—Ä–∞–≤–Ω–∏–≤–∞–µ–º—ã–π –¥–æ–∫—É–º–µ–Ω—Ç:</strong> {{ comparison.compared_document.title }} (v{{ comparison.compared_document.version }})</p>
                        <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ comparison.created_date|date:"d.m.Y H:i" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–ú–æ–¥–µ–ª—å –Ω–µ–π—Ä–æ—Å–µ—Ç–∏:</strong> {{ model_info.method }}</p>
                        <p><strong>–¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞:</strong> {{ model_info.type }}</p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                            <span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç—á–µ—Ç–∞—Ö -->
        {% if latest_report %}
        <div class="alert alert-success mb-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-file-alt fa-2x me-3"></i>
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-check-circle"></i> –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
                    </h6>
                    <p class="mb-1">
                        <strong>–§–æ—Ä–º–∞—Ç:</strong> {{ latest_report.format|upper }}
                        <strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> {{ latest_report.generated_date|date:"d.m.Y H:i" }}
                    </p>
                    <div>
                        <a href="{% url 'reports:detail' latest_report.id %}" class="btn btn-sm btn-success me-2">
                            <i class="fas fa-eye"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                        </a>
                        <a href="{{ latest_report.file.url }}" class="btn btn-sm btn-primary" target="_blank">
                            <i class="fas fa-download"></i> –°–∫–∞—á–∞—Ç—å
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% elif reports.exists %}
        <div class="alert alert-info mb-4">
            <div class="d-flex align-items-center">
                <i class="fas fa-file-alt fa-2x me-3"></i>
                <div>
                    <h6 class="mb-1">
                        <i class="fas fa-info-circle"></i> –î–æ—Å—Ç—É–ø–Ω—ã –æ—Ç—á–µ—Ç—ã
                    </h6>
                    <p class="mb-1">
                        –°–æ–∑–¥–∞–Ω–æ –æ—Ç—á–µ—Ç–æ–≤: {{ reports.count }}
                    </p>
                    <a href="{% url 'reports:list' %}" class="btn btn-sm btn-info">
                        <i class="fas fa-list"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ -->
        {% if comparison.status == 'completed' and comparison.analysis_result %}
            <div class="analysis-result">
                <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞</h4>
                
                {% if comparison.analysis_result.summary %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> –†–µ–∑—é–º–µ</h6>
                        <p>{{ comparison.analysis_result.summary }}</p>
                    </div>
                {% endif %}
                
                <!-- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ -->
                {% if comparison.analysis_result.similarities %}
                    <div class="similarities">
                        <h5><i class="fas fa-check-circle text-success"></i> –°—Ö–æ–¥—Å—Ç–≤–∞</h5>
                        <ul class="list-group">
                            {% for similarity in comparison.analysis_result.similarities %}
                                <li class="list-group-item">{{ similarity }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <!-- –†–∞–∑–ª–∏—á–∏—è -->
                {% if comparison.analysis_result.differences %}
                    <div class="differences">
                        <h5><i class="fas fa-exclamation-triangle text-warning"></i> –†–∞–∑–ª–∏—á–∏—è</h5>
                        {% for difference in comparison.analysis_result.differences %}
                            <div class="difference-item {{ difference.significance|default:'medium' }}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6>{{ difference.description }}</h6>
                                        {% if difference.location %}
                                            <small class="text-muted"><strong>–ú–µ—Å—Ç–æ:</strong> {{ difference.location }}</small><br>
                                        {% endif %}
                                        {% if difference.type %}
                                            <span class="badge bg-secondary">{{ difference.type }}</span>
                                        {% endif %}
                                        {% if difference.significance %}
                                            <span class="badge bg-{% if difference.significance == 'high' %}danger{% elif difference.significance == 'medium' %}warning{% else %}success{% endif %}">
                                                {{ difference.significance|title }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if difference.old_value or difference.new_value %}
                                    <div class="mt-2">
                                        {% if difference.old_value %}
                                            <div class="mb-1">
                                                <small class="text-muted">–ë—ã–ª–æ:</small>
                                                <div class="bg-light p-2 rounded">{{ difference.old_value }}</div>
                                            </div>
                                        {% endif %}
                                        {% if difference.new_value %}
                                            <div>
                                                <small class="text-muted">–°—Ç–∞–ª–æ:</small>
                                                <div class="bg-light p-2 rounded">{{ difference.new_value }}</div>
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
                
                <!-- –ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ -->
                {% if comparison.analysis_result.base_document_sentiment %}
                    <div class="sentiment-analysis">
                        <div class="sentiment-card sentiment-{{ comparison.analysis_result.base_document_sentiment.sentiment }}">
                            <h6>{{ comparison.base_document.title }} (v{{ comparison.base_document.version }})</h6>
                            <div class="mb-2">
                                <span class="badge bg-{% if comparison.analysis_result.base_document_sentiment.sentiment == 'positive' %}success{% elif comparison.analysis_result.base_document_sentiment.sentiment == 'negative' %}danger{% else %}secondary{% endif %}">
                                    {{ comparison.analysis_result.base_document_sentiment.sentiment|title }}
                                </span>
                            </div>
                            {% if comparison.analysis_result.base_document_sentiment.confidence %}
                                <small>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {{ comparison.analysis_result.base_document_sentiment.confidence|floatformat:2 }}</small>
                            {% endif %}
                            {% if comparison.analysis_result.base_document_sentiment.summary %}
                                <p class="small mt-2">{{ comparison.analysis_result.base_document_sentiment.summary }}</p>
                            {% endif %}
                        </div>
                        
                        <div class="sentiment-card sentiment-{{ comparison.analysis_result.compared_document_sentiment.sentiment }}">
                            <h6>{{ comparison.compared_document.title }} (v{{ comparison.compared_document.version }})</h6>
                            <div class="mb-2">
                                <span class="badge bg-{% if comparison.analysis_result.compared_document_sentiment.sentiment == 'positive' %}success{% elif comparison.analysis_result.compared_document_sentiment.sentiment == 'negative' %}danger{% else %}secondary{% endif %}">
                                    {{ comparison.analysis_result.compared_document_sentiment.sentiment|title }}
                                </span>
                            </div>
                            {% if comparison.analysis_result.compared_document_sentiment.confidence %}
                                <small>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {{ comparison.analysis_result.compared_document_sentiment.confidence|floatformat:2 }}</small>
                            {% endif %}
                            {% if comparison.analysis_result.compared_document_sentiment.summary %}
                                <p class="small mt-2">{{ comparison.analysis_result.compared_document_sentiment.summary }}</p>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã -->
                {% if comparison.analysis_result.base_document_key_points %}
                    <div class="key-points">
                        <div class="key-points-card">
                            <h6>{{ comparison.base_document.title }} (v{{ comparison.base_document.version }})</h6>
                            {% if comparison.analysis_result.base_document_key_points.key_points %}
                                {% for point in comparison.analysis_result.base_document_key_points.key_points %}
                                    <div class="key-point-item {{ point.importance|default:'medium' }}">
                                        <strong>{{ point.point }}</strong>
                                        {% if point.importance %}
                                            <span class="badge bg-{% if point.importance == 'high' %}danger{% elif point.importance == 'medium' %}warning{% else %}success{% endif %} float-end">
                                                {{ point.importance|title }}
                                            </span>
                                        {% endif %}
                                        {% if point.category %}
                                            <br><small class="text-muted">{{ point.category }}</small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <div class="key-points-card">
                            <h6>{{ comparison.compared_document.title }} (v{{ comparison.compared_document.version }})</h6>
                            {% if comparison.analysis_result.compared_document_key_points.key_points %}
                                {% for point in comparison.analysis_result.compared_document_key_points.key_points %}
                                    <div class="key-point-item {{ point.importance|default:'medium' }}">
                                        <strong>{{ point.point }}</strong>
                                        {% if point.importance %}
                                            <span class="badge bg-{% if point.importance == 'high' %}danger{% elif point.importance == 'medium' %}warning{% else %}success{% endif %} float-end">
                                                {{ point.importance|title }}
                                            </span>
                                        {% endif %}
                                        {% if point.category %}
                                            <br><small class="text-muted">{{ point.category }}</small>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
                
                <!-- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ -->
                {% if comparison.analysis_result.recommendations %}
                    <div class="recommendations">
                        <h5><i class="fas fa-lightbulb text-warning"></i> –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h5>
                        <ul class="list-group">
                            {% for recommendation in comparison.analysis_result.recommendations %}
                                <li class="list-group-item">{{ recommendation }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}
                
                <!-- –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ -->
                {% if comparison.analysis_result.overall_assessment %}
                    <div class="alert alert-primary">
                        <h6><i class="fas fa-chart-line"></i> –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞</h6>
                        <p>{{ comparison.analysis_result.overall_assessment }}</p>
                    </div>
                {% endif %}
                
                <!-- –°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏ -->
                {% if comparison.analysis_result.raw_analysis %}
                    <div class="mt-4">
                        <h6>–°—ã—Ä–æ–π –æ—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏</h6>
                        <div class="raw-response">{{ comparison.analysis_result.raw_analysis }}</div>
                    </div>
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –Ω–µ –±—ã–ª–∏ –ø–æ–ª—É—á–µ–Ω—ã.
            </div>
        {% endif %}
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ -->
        {% if comparison.status != 'completed' %}
        <div class="card mb-4">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                <h5>–ê–Ω–∞–ª–∏–∑ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h5>
                <p class="text-muted">
                    {% if comparison.status == 'pending' %}
                        –ê–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏.
                    {% elif comparison.status == 'processing' %}
                        –ù–µ–π—Ä–æ—Å–µ—Ç—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤. –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.
                    {% elif comparison.status == 'error' %}
                        –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∞–ª–∏–∑–∞.
                    {% endif %}
                </p>
                <button class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
                </button>
            </div>
        </div>
        {% endif %}
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω–æ–º –∞–Ω–∞–ª–∏–∑–µ
{% if comparison.status == 'pending' or comparison.status == 'processing' %}
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(function() {
        location.reload();
    }, 10000);
{% endif %}
</script>
{% endblock %}
