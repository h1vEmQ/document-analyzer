{% extends 'base/base.html' %}

{% block title %}–ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ - Document analyzer{% endblock %}

{% block extra_css %}
<style>
    .ollama-status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .ollama-status.available {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }
    .ollama-status.unavailable {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }
    .analysis-type-info {
        background-color: #e2e3e5;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 15px;
    }
    .model-info {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üß† –ê–Ω–∞–ª–∏–∑ —Å –ø–æ–º–æ—â—å—é –Ω–µ–π—Ä–æ—Å–µ—Ç–∏</h2>
            <a href="{% url 'analysis:list' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
            </a>
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å Ollama -->
        <div class="ollama-status {% if ollama_available %}available{% else %}unavailable{% endif %}">
            <div class="d-flex align-items-center">
                <i class="fas {% if ollama_available %}fa-check-circle{% else %}fa-exclamation-triangle{% endif %} me-2"></i>
                <div>
                    <strong>–°—Ç–∞—Ç—É—Å Ollama:</strong>
                    {% if ollama_available %}
                        –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω
                        {% if available_models %}
                            <span class="badge bg-success ms-2">{{ available_models|length }} –º–æ–¥–µ–ª–µ–π</span>
                        {% endif %}
                    {% else %}
                        –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:11434
                    {% endif %}
                </div>
            </div>
            {% if available_models %}
                <div class="model-info mt-2">
                    <small><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:</strong> {{ available_models|join:", " }}</small>
                </div>
            {% endif %}
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω–∞–ª–∏–∑–∞</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.base_document.id_for_label }}" class="form-label">
                                    {{ form.base_document.label }}
                                </label>
                                {{ form.base_document }}
                                {% if form.base_document.help_text %}
                                    <div class="form-text">{{ form.base_document.help_text }}</div>
                                {% endif %}
                                {% for error in form.base_document.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.compared_document.id_for_label }}" class="form-label">
                                    {{ form.compared_document.label }}
                                </label>
                                {{ form.compared_document }}
                                {% if form.compared_document.help_text %}
                                    <div class="form-text">{{ form.compared_document.help_text }}</div>
                                {% endif %}
                                {% for error in form.compared_document.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.analysis_type.id_for_label }}" class="form-label">
                                    {{ form.analysis_type.label }}
                                </label>
                                {{ form.analysis_type }}
                                {% if form.analysis_type.help_text %}
                                    <div class="form-text">{{ form.analysis_type.help_text }}</div>
                                {% endif %}
                                {% for error in form.analysis_type.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                                
                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–∏–ø–∞—Ö –∞–Ω–∞–ª–∏–∑–∞ -->
                                <div class="analysis-type-info mt-2">
                                    <small>
                                        <strong>–¢–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞:</strong><br>
                                        ‚Ä¢ <strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:</strong> –ü–æ–∏—Å–∫ —Ä–∞–∑–ª–∏—á–∏–π, —Å—Ö–æ–¥—Å—Ç–≤ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π<br>
                                        ‚Ä¢ <strong>–ê–Ω–∞–ª–∏–∑ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:</strong> –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ —Ç–µ–∫—Å—Ç–∞<br>
                                        ‚Ä¢ <strong>–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong> –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –≤–∞–∂–Ω—ã—Ö –∏–¥–µ–π –∏ —Ç–µ–º
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.model.id_for_label }}" class="form-label">
                                    {{ form.model.label }}
                                </label>
                                {{ form.model }}
                                {% if form.model.help_text %}
                                    <div class="form-text">{{ form.model.help_text }}</div>
                                {% endif %}
                                {% for error in form.model.errors %}
                                    <div class="text-danger">{{ error }}</div>
                                {% endfor %}
                                
                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö -->
                                <div class="model-info mt-2">
                                    <small>
                                        {% if available_models and available_models|length > 0 %}
                                            <strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:</strong><br>
                                            {% for model in available_models %}
                                                ‚Ä¢ {{ model }}<br>
                                            {% endfor %}
                                        {% else %}
                                            <i class="fas fa-exclamation-triangle text-warning"></i>
                                            <strong>–ú–æ–¥–µ–ª–∏ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã</strong><br>
                                            –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –º–æ–¥–µ–ª–∏ –≤ Ollama –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
                                        {% endif %}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            {{ form.title.label }}
                        </label>
                        {{ form.title }}
                        {% if form.title.help_text %}
                            <div class="form-text">{{ form.title.help_text }}</div>
                        {% endif %}
                        {% for error in form.title.errors %}
                            <div class="text-danger">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'analysis:list' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                        <button type="submit" class="btn btn-primary" {% if not ollama_available %}disabled{% endif %}>
                            <i class="fas fa-brain"></i> 
                            {% if ollama_available %}–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑{% else %}Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ Ollama:</h6>
                        <ul class="small">
                            <li>–°–∫–∞—á–∞–π—Ç–µ Ollama —Å <a href="https://ollama.ai" target="_blank">ollama.ai</a></li>
                            <li>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å</li>
                            <li>–°–∫–∞—á–∞–π—Ç–µ –º–æ–¥–µ–ª—å: <code>ollama pull llama3</code></li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –º–æ–¥–µ–ª–∏:</h6>
                        <ul class="small">
                            <li><strong>llama3:</strong> –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</li>
                            <li><strong>llama3.1:</strong> –£–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è Llama 3</li>
                            <li><strong>mistral:</strong> –ë—ã—Å—Ç—Ä–∞—è –º–æ–¥–µ–ª—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</li>
                            <li><strong>codellama:</strong> –î–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const analysisTypeSelect = document.getElementById('{{ form.analysis_type.id_for_label }}');
    const modelSelect = document.getElementById('{{ form.model.id_for_label }}');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
    analysisTypeSelect.addEventListener('change', function() {
        updateAnalysisDescription(this.value);
    });
    
    function updateAnalysisDescription(type) {
        const descriptions = {
            'comparison': '–ü–æ–∏—Å–∫ —Ä–∞–∑–ª–∏—á–∏–π, —Å—Ö–æ–¥—Å—Ç–≤ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –º–µ–∂–¥—É –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏',
            'sentiment': '–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–π –æ–∫—Ä–∞—Å–∫–∏ –∏ —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞',
            'key_points': '–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤, –∏–¥–µ–π –∏ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–º'
        };
        
        const description = descriptions[type] || '';
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å Ollama –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(function() {
        fetch('{% url "analysis:ollama_status" %}')
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.querySelector('.ollama-status');
                const submitBtn = document.querySelector('button[type="submit"]');
                
                if (data.available) {
                    statusDiv.className = 'ollama-status available';
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <div>
                                <strong>–°—Ç–∞—Ç—É—Å Ollama:</strong> –°–µ—Ä–≤–∏—Å –¥–æ—Å—Ç—É–ø–µ–Ω
                                <span class="badge bg-success ms-2">${data.models.length} –º–æ–¥–µ–ª–µ–π</span>
                            </div>
                        </div>
                        ${data.models.length > 0 ? `
                            <div class="model-info mt-2">
                                <small><strong>–î–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏:</strong> ${data.models.join(', ')}</small>
                            </div>
                        ` : ''}
                    `;
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-brain"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑';
                } else {
                    statusDiv.className = 'ollama-status unavailable';
                    statusDiv.innerHTML = `
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>–°—Ç–∞—Ç—É—Å Ollama:</strong> –°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω –Ω–∞ localhost:11434
                            </div>
                        </div>
                    `;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-brain"></i> Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
                }
            })
            .catch(error => {
                console.error('Error checking Ollama status:', error);
            });
    }, 30000);
});
</script>
{% endblock %}
