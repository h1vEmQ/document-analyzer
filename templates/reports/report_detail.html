{% extends 'base/base.html' %}

{% block title %}{{ report.title }} - WARA{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1>üìä {{ report.title }}</h1>
                {% if total_versions > 1 %}
                    <div class="d-flex align-items-center mt-2">
                        <span class="badge bg-info me-2">
                            <i class="fas fa-code-branch"></i> {{ total_versions }} –≤–µ—Ä—Å–∏–π
                        </span>
                        {% if not is_current_latest %}
                            <span class="badge bg-warning me-2">
                                <i class="fas fa-info-circle"></i> –í–µ—Ä—Å–∏—è {{ report.version }}
                            </span>
                        {% else %}
                            <span class="badge bg-success me-2">
                                <i class="fas fa-star"></i> –ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è
                            </span>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
            <div class="btn-group" role="group">
                {% if report.file %}
                    <a href="{% url 'reports:download' report.pk %}" class="btn btn-success">
                        üì• –°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç
                    </a>
                {% endif %}
                <a href="{% url 'reports:delete' report.pk %}" class="btn btn-danger">
                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ—Ç—á–µ—Ç
                </a>
            </div>
        </div>

        {% if total_versions > 1 %}
            <!-- –°–µ–ª–µ–∫—Ç–æ—Ä –≤–µ—Ä—Å–∏–π -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-code-branch"></i> –í—ã–±–æ—Ä –≤–µ—Ä—Å–∏–∏ –æ—Ç—á–µ—Ç–∞
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="version-selector" class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –≤–µ—Ä—Å–∏—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:</label>
                            <select class="form-select" id="version-selector" onchange="changeReportVersion(this.value)">
                                {% for version in all_versions %}
                                    <option value="{{ version.pk }}" {% if version.pk == report.pk %}selected{% endif %}>
                                        v{{ version.version }} - {{ version.generated_date|date:"d.m.Y H:i" }}
                                        {% if version.is_latest_version %} (–ü–æ—Å–ª–µ–¥–Ω—è—è){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–µ—Ä—Å–∏—è—Ö:</label>
                            <div class="alert alert-light">
                                <small>
                                    <strong>–í—Å–µ–≥–æ –≤–µ—Ä—Å–∏–π:</strong> {{ total_versions }}<br>
                                    <strong>–¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è:</strong> v{{ report.version }}<br>
                                    <strong>–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è:</strong> v{{ latest_version.version }}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç—á–µ—Ç–µ</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong></td>
                                <td>{{ report.title }}</td>
                            </tr>
                            <tr>
                                <td><strong>–§–æ—Ä–º–∞—Ç:</strong></td>
                                <td>
                                    <span class="badge bg-primary">{{ report.get_format_display }}</span>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–í–µ—Ä—Å–∏—è:</strong></td>
                                <td>
                                    <span class="badge bg-secondary">v{{ report.version }}</span>
                                    {% if report.is_latest_version %}
                                        <span class="badge bg-success ms-1">–ü–æ—Å–ª–µ–¥–Ω—è—è</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ç–∞—Ç—É—Å:</strong></td>
                                <td>
                                    {% if report.status == 'generating' %}
                                        <span class="badge bg-warning">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è</span>
                                    {% elif report.status == 'ready' %}
                                        <span class="badge bg-success">–ì–æ—Ç–æ–≤</span>
                                    {% elif report.status == 'sent' %}
                                        <span class="badge bg-info">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω</span>
                                    {% elif report.status == 'error' %}
                                        <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:</strong></td>
                                <td>
                                    <a href="{% url 'analysis:detail' report.comparison.pk %}">
                                        {{ report.comparison.title }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–î–∞—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong></td>
                                <td>{{ report.generated_date|date:"d.m.Y H:i" }}</td>
                            </tr>
                            {% if report.sent_date %}
                                <tr>
                                    <td><strong>–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong></td>
                                    <td>{{ report.sent_date|date:"d.m.Y H:i" }}</td>
                                </tr>
                            {% endif %}
                            {% if report.generation_time %}
                                <tr>
                                    <td><strong>–í—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</strong></td>
                                    <td>{{ report.generation_time }} —Å–µ–∫</td>
                                </tr>
                            {% endif %}
                            {% if report.file_size %}
                                <tr>
                                    <td><strong>–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞:</strong></td>
                                    <td>{{ report.get_file_size_mb }} –ú–ë</td>
                                </tr>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm">
                            <tr>
                                <td><strong>–®–∞–±–ª–æ–Ω:</strong></td>
                                <td>{{ report.template_used }}</td>
                            </tr>
                            <tr>
                                <td><strong>–í–∫–ª—é—á–∏—Ç—å —Å–≤–æ–¥–∫—É:</strong></td>
                                <td>
                                    {% if report.include_summary %}
                                        <span class="badge bg-success">–î–∞</span>
                                    {% else %}
                                        <span class="badge bg-secondary">–ù–µ—Ç</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏:</strong></td>
                                <td>
                                    {% if report.include_details %}
                                        <span class="badge bg-success">–î–∞</span>
                                    {% else %}
                                        <span class="badge bg-secondary">–ù–µ—Ç</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–í–∫–ª—é—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã:</strong></td>
                                <td>
                                    {% if report.include_tables %}
                                        <span class="badge bg-success">–î–∞</span>
                                    {% else %}
                                        <span class="badge bg-secondary">–ù–µ—Ç</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {% if report.email_recipients %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìß Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>–°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong>
                                    {% if report.email_sent %}
                                        <span class="badge bg-success">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                                    {% else %}
                                        <span class="badge bg-warning">–ù–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</span>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª–∏:</strong>
                                    <ul class="list-unstyled">
                                        {% for recipient in report.email_recipients %}
                                            <li><small>{{ recipient }}</small></li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}

        {% if report.summary_data %}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5>üìà –î–∞–Ω–Ω—ã–µ —Å–≤–æ–¥–∫–∏</h5>
                        </div>
                        <div class="card-body">
                            <div class="bg-light p-3 rounded">
                                <pre>{{ report.summary_data|pprint }}</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
function changeReportVersion(versionId) {
    if (versionId) {
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
        window.location.href = '/reports/' + versionId + '/';
    }
}
</script>
{% endblock %}
